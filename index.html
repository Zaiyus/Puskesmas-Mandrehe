<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Indikator Kinerja Puskesmas</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBU01vW9-cHiCA9NAHQKJiQTuxntOleHKs",
            authDomain: "puskesmas-mandrehe.firebaseapp.com",
            databaseURL: "https://puskesmas-mandrehe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "puskesmas-mandrehe",
            storageBucket: "puskesmas-mandrehe.firebasestorage.app",
            messagingSenderId: "663681192145",
            appId: "1:663681192145:web:6be4bfe4f8e514fa7935f0",
            measurementId: "G-KC7VM19453" // Ini optional, tapi dimasukkan agar lengkap
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore(); // Inisialisasi Cloud Firestore
        
        let CURRENT_USER_UID = null;
        const USER_COLLECTION = 'puskesmas_users';
    </script>
    </head>
<body>
    <div class="header">
        <h1>Dashboard Indikator Kinerja Puskesmas Mandrehe</h1>
        <p>Berdasarkan Klaster ILP (Permenkes 19/2024)</p>
        <p>Dibuat Oleh : Yusmar Christianto Zai, S.Kep.,Ns.</p>
        <button id="logout-btn" class="btn-primary" style="display: none; margin-top: 15px; background-color: var(--color-danger);" onclick="logoutUser()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <div class="auth-section" id="authSection">
        <div class="auth-box">
            <h3><i class="fas fa-lock"></i> Akses Dashboard</h3>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn-primary" id="btn-login"><i class="fas fa-sign-in-alt"></i> Login</button>
                <button type="button" class="btn-primary" id="btn-show-register" style="background-color: var(--color-purple); margin-top: 10px;"><i class="fas fa-user-plus"></i> Buat Akun</button>
            </form>
            
            <form id="register-form" style="display: none;">
                <h4><i class="fas fa-user-plus"></i> Register Akun Baru</h4>
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Password (min 6 karakter)" required>
                <button type="submit" class="btn-primary"><i class="fas fa-user-plus"></i> Register & Login</button>
                <button type="button" class="btn-primary" id="btn-show-login" style="background-color: var(--color-info); margin-top: 10px;">Kembali ke Login</button>
            </form>
            <p id="auth-error" style="color: var(--color-danger); margin-top: 10px;"></p>
        </div>
    </div>
    <div class="container content-hidden" id="mainContainer"> 
        <div class="controls-bar">
            <div class="control-group">
                <label for="select-tahun"><i class="fas fa-calendar-alt"></i> Tahun:</label>
                <select id="select-tahun" onchange="changePeriod()"></select>
            </div>
            <div class="control-group">
                <label for="select-bulan"><i class="fas fa-calendar-day"></i> Bulan:</label>
                <select id="select-bulan" onchange="changePeriod()"></select>
            </div>
            
            <div class="control-group">
                <label for="select-unit-type"><i class="fas fa-sliders-h"></i> Satuan Data Tampilan:</label>
                <select id="select-unit-type" onchange="changeUnitType()">
                    <option value="raw" selected>Satuan Asli (%)</option>
                    <option value="permil">Permil (‰)</option>
                    <option value="per100000">Per 100.000</option>
                    <option value="per100">Per 100</option>
                </select>
            </div>
        </div>
        
        <div class="current-period-display">
            Periode Data: 
            <span id="current-month-display" class="display-badge"></span> 
            <span id="current-year-display" class="display-badge"></span>
        </div>
        
        <div class="add-indicator-form">
            <h3><i class="fas fa-edit"></i> Input & Kelola Data</h3>
            
            <div class="form-section">
                <h4>1. Input Capaian Bulan Ini (Alternatif)</h4>
                <form id="capaian-form">
                    <select id="select-indikator-capaian" required>
                        <option value="" disabled selected>Pilih Indikator untuk Input Capaian</option>
                    </select>
                    <input type="number" id="input-capaian-num" placeholder="Pembilang (Capaian)" step="0.01">
                    <input type="number" id="input-capaian-den" placeholder="Penyebut (Sasaran)" step="0.01">
                    <button type="submit" class="btn-primary btn-save"><i class="fas fa-save"></i> Simpan Capaian</button>
                </form>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #EAECEE; margin: 30px 0;">
            
            <div class="form-section">
                <h4>2. Tambah Indikator Baru</h4>
                <form id="new-indicator-form">
                    <input type="text" id="new-indikator-name" placeholder="Nama Indikator Lengkap" required>
                    <input type="number" id="new-indikator-target" placeholder="Target Angka (Contoh: 100)" step="0.01" required>
                    <select id="new-indikator-satuan" required>
                        <option value="%">% (Persen)</option>
                        <option value="‰">‰ (Permil)</option>
                        <option value="/100.000">/100.000 (Rate Kematian/AKI)</option>
                        <option value="/100">/100</option>
                        <option value="Rasio">Rasio</option>
                        <option value="Indeks">Indeks</option>
                        <option value="Tema">Tema (KIE)</option>
                        <option value="/mil">/mil (AK BPJS)</option>
                    </select>
                    <select id="new-indikator-klaster" required>
                        <option value="1">Klaster 1: MANAJEMEN</option>
                        <option value="2" selected>Klaster 2: IBU DAN ANAK</option>
                        <option value="3">Klaster 3: DEWASA DAN LANSIA</option>
                        <option value="4">Klaster 4: P2M & KESLING</option>
                        <option value="5">Klaster 5: LINTAS KLASTER</option>
                    </select>
                    <select id="new-indikator-direction" required>
                        <option value="higher" selected>Semakin TINGGI Semakin Baik (↑)</option>
                        <option value="lower">Semakin RENDAH Semakin Baik (↓)</option>
                    </select>
                    <button type="submit" class="btn-primary btn-add"><i class="fas fa-plus-circle"></i> Tambah Indikator</button>
                </form>
            </div>
        </div>
        
        <div id="summary-cards" class="summary-cards">
            </div>

        <div class="detail-container" id="detail-chart-area">
            <h2><i class="fas fa-chart-line"></i> Detail Indikator: <span id="detail-indicator-name">Pilih Indikator di Tabel Bawah</span></h2>
            <div class="chart-controls">
                <button class="btn-primary btn-png" id="download-chart-btn" style="display:none;" 
                    onclick="downloadCurrentChart(document.getElementById('detailChart').dataset.indikatorId)">
                    <i class="fas fa-file-image"></i> Download Grafik (PNG)
                </button>
                <span id="detail-current-target" class="display-badge target-badge">Target: -</span>
            </div>
            <div class="chart-container">
                <canvas id="detailChart"></canvas>
            </div>
        </div>
        
        <div class="data-table-container" id="main-data-table-section">
            <h3><i class="fas fa-list-alt"></i> Daftar Indikator (Edit Langsung di Tabel)</h3>
            <div class="table-controls">
                <label for="filter-klaster-table">Filter Klaster:</label>
                <select id="filter-klaster-table" onchange="renderDetailTable()">
                    <option value="0">Semua Klaster</option>
                    <option value="1">Klaster 1: MANAJEMEN</option>
                    <option value="2">Klaster 2: IBU DAN ANAK</option>
                    <option value="3">Klaster 3: DEWASA DAN LANSIA</option>
                    <option value="4">Klaster 4: P2M & KESLING</option>
                    <option value="5">Klaster 5: LINTAS KLASTER</option>
                </select>
            </div>
            <table id="data-table">
                </table>
            <p style="margin-top: 15px; font-style: italic; color: var(--color-text-medium); font-size: 0.9em;">* Klik atau ubah langsung pada kolom yang berwarna putih (Indikator Kinerja) atau pada input/dropdown di kolom Target, Satuan, Arah Target, dan Capaian.</p>
        </div>

    </div>

    <script src="script.js"></script>
</body>
</html>
